# .github/workflows/build_and_push.yml

name: CICD for ETL Project (Docker Hub)

# KÃ­ch hoáº¡t workflow khi cÃ³ push lÃªn nhÃ¡nh 'main'
on:
  push:
    branches: [ "master" ]
  # Báº¡n cÃ³ thá»ƒ thÃªm 'workflow_dispatch:' Ä‘á»ƒ cháº¡y thá»§ cÃ´ng tá»« GitHub UI

# Äá»‹nh nghÄ©a cÃ¡c cÃ´ng viá»‡c (jobs) sáº½ cháº¡y
jobs:
  build_and_push:
    # Chá»n há»‡ Ä‘iá»u hÃ nh Ä‘á»ƒ cháº¡y job
    runs-on: ubuntu-latest

    # CÃ¡c bÆ°á»›c sáº½ Ä‘Æ°á»£c thá»±c hiá»‡n trong job nÃ y
    steps:
      - name: ğŸ“¦ Checkout code
        # Láº¥y code tá»« repo
        uses: actions/checkout@v4

      - name: âš™ï¸ Set up Docker Buildx
        # Thiáº¿t láº­p Docker Buildx Ä‘á»ƒ build image hiá»‡u quáº£
        uses: docker/setup-buildx-action@v3

      - name: ğŸ”‘ Log in to Docker Hub
        # ÄÄƒng nháº­p vÃ o Docker Hub báº±ng secrets Ä‘Ã£ thiáº¿t láº­p
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: ğŸ·ï¸ Extract metadata (tags) for Docker
        # Tá»± Ä‘á»™ng táº¡o tÃªn vÃ  tags cho image dá»±a trÃªn tÃªn repo vÃ  commit SHA
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ secrets.DOCKER_USERNAME }}/customer-etl-project 
          tags: |
            # 1. Tháº» 'latest' (chá»‰ cho nhÃ¡nh master)
            type=raw,value=latest,enable=${{ github.ref == 'refs/heads/master' }}
            # 2. Tháº» dá»±a trÃªn SHA (sá»­ dá»¥ng SHA ngáº¯n lÃ m máº·c Ä‘á»‹nh)
            type=sha,prefix=

      - name: ğŸ—ï¸ Build and Push Docker image
        uses: docker/build-push-action@v5 
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          # Báº¡n cÃ³ thá»ƒ chá»‰ Ä‘á»‹nh Dockerfile náº¿u nÃ³ khÃ´ng á»Ÿ thÆ° má»¥c gá»‘c,
          # nhÆ°ng trong trÆ°á»ng há»£p cá»§a báº¡n, nÃ³ Ä‘Ã£ á»Ÿ thÆ° má»¥c gá»‘c (context: .)